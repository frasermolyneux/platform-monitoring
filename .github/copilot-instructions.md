# Copilot Instructions

- Purpose: Terraform configuration for Azure monitoring resources for non-Azure workloads; CI badges in README but execution is local/Azure DevOps.
- Layout: [terraform/](terraform) provisions shared monitoring infra (RG, Key Vault, Log Analytics, action groups, workbooks); [terraform-sub/](terraform-sub) applies subscription-level activity log alerts that re-use shared action groups.
- State: remote backend defined per env in [terraform/backends](terraform/backends) and [terraform-sub/backends](terraform-sub/backends) (Azure Storage + OIDC). Init with `terraform -chdir=terraform init -backend-config=backends/dev.backend.hcl` (or prd), same pattern for `terraform-sub`.
- Apply: `terraform -chdir=terraform apply -var-file=tfvars/dev.tfvars` (or prd). Then `terraform -chdir=terraform-sub apply -var-file=tfvars/dev.tfvars` to push subscription alerts; adjust env file accordingly. Run `terraform fmt` before commits (terraform version >=1.14.3, azurerm ~>4.57.0).
- Variables: root uses `environment`, `locations` (list), `subscription_id`, `subscriptions` map (name/id pairs surfaced in outputs), `tags` ([terraform/variables.tf](terraform/variables.tf)). Submodule uses single `location`, `subscription_name`, `subscription_id`, `action_group_subscription_id`, `tags` ([terraform-sub/variables.tf](terraform-sub/variables.tf)).
- Environments: tfvars define dev/prd values ([terraform/tfvars](terraform/tfvars), [terraform-sub/tfvars](terraform-sub/tfvars)). prd sub tfvars currently use `locations` instead of `location`; fix to `location` before apply.
- Resource groups: named `rg-platform-monitoring-${environment}-${location}` for shared assets and `rg-platform-alerts-${environment}-${location}` for subscription alerts ([terraform/resource_group.tf](terraform/resource_group.tf), [terraform-sub/resource_group.tf](terraform-sub/resource_group.tf)).
- Key Vault: name `kv-${random_id}-${primary_location}`, RBAC enabled, soft delete/purge protection on ([terraform/key_vault.tf](terraform/key_vault.tf)).
- Secrets: placeholder secrets `alert-phone`, `alert-email` created with ignore_changes ([terraform/key_vault_secrets.tf](terraform/key_vault_secrets.tf)); after first apply set real values manually per [docs/manual-steps.md](docs/manual-steps.md).
- Action groups: p0â€“p4 groups created per env ([terraform/monitor_action_groups.tf](terraform/monitor_action_groups.tf)); SMS/email/app push only on prd. Names referenced by subscription alert module via `action_group_subscription_id` and `rg-platform-monitoring-${environment}-${location}`.
- Log Analytics: one workspace per env/location (`log-platform-monitoring-${environment}-${location}`) ([terraform/log_analytics.tf](terraform/log_analytics.tf)); IDs exposed in outputs.
- Workbooks: JSON templates under [terraform/workbooks](terraform/workbooks) are auto-discovered and deployed with GUID names ([terraform/workbooks.tf](terraform/workbooks.tf)). Add/edit JSON to create/update workbooks; display name becomes `platform-monitoring-{file-stem}-{environment}`.
- Subscriptions data: root module ingests `subscriptions` map into data sources and outputs for downstream use ([terraform/data.subscriptions.tf](terraform/data.subscriptions.tf), [terraform/outputs.tf](terraform/outputs.tf)).
- Subscription alerts: `terraform-sub` creates activity log alerts for ResourceHealth and ServiceHealth severities, routing to action groups by severity (e.g., Security -> high, Maintenance/Informational -> informational) ([terraform-sub/resource_health_alerts.tf](terraform-sub/resource_health_alerts.tf), [terraform-sub/service_health_alerts.tf](terraform-sub/service_health_alerts.tf)).
- Tagging: keep `Environment`, `Workload`, `DeployedBy`, `Git` tags consistent with tfvars when adding resources to ensure workbooks/filters stay meaningful.
- Manual prep: backend storage accounts/resource groups must exist (see backend hcl), and deploy service principal comes from related `azure-landing-zones` project (per README link).
- When extending: reuse provider aliases if adding cross-subscription resources; ensure new workbooks or alerts respect existing naming/tagging to keep dashboards coherent.
