# Copilot Instructions

- Purpose: Terraform repo provisioning Azure monitoring for non-Azure workloads; CI badges live in README but execution is local/Azure DevOps, not GitHub Actions.
- Layout: [terraform/](terraform) is the shared infra module (resource groups, Key Vault, Log Analytics, action groups, workbooks); [terraform-sub/](terraform-sub) is a per-subscription module wiring Azure Activity Log alerts into those shared action groups.
- Toolchain: Terraform >=1.14.3 with azurerm ~>4.57.0 ([terraform/providers.tf](terraform/providers.tf), [terraform-sub/providers.tf](terraform-sub/providers.tf)); run `terraform fmt` pre-commit.
- Backend/state: Remote azurerm backends per env at [terraform/backends](terraform/backends) and [terraform-sub/backends](terraform-sub/backends). Init via `terraform -chdir=terraform init -backend-config=backends/dev.backend.hcl` (swap prd); same for terraform-sub.
- Apply flow: `terraform -chdir=terraform apply -var-file=tfvars/dev.tfvars` (or prd) to create shared assets; then `terraform -chdir=terraform-sub apply -var-file=tfvars/dev.tfvars -var "subscription_name=..." -var "subscription_id=..."` for each workload subscription. prd sub tfvars currently use `locations`; change to `location` before running.
- Core variables: Root module expects `environment`, `locations` (list, first element drives most resources), `subscription_id`, `subscriptions` map for data/outputs, `tags` ([terraform/variables.tf](terraform/variables.tf)). Submodule needs `environment`, `location`, `subscription_name`, `subscription_id`, `action_group_subscription_id`, `tags` ([terraform-sub/variables.tf](terraform-sub/variables.tf)).
- Naming: Resource groups use `rg-platform-monitoring-${environment}-${location}` and `rg-platform-alerts-${environment}-${location}` ([terraform/resource_group.tf](terraform/resource_group.tf), [terraform-sub/resource_group.tf](terraform-sub/resource_group.tf)); Key Vault name is randomized per env ([terraform/key_vault.tf](terraform/key_vault.tf)).
- Security/secrets: Key Vault has RBAC+purge protection; secrets `alert-phone` and `alert-email` are placeholders with `ignore_changes` ([terraform/key_vault_secrets.tf](terraform/key_vault_secrets.tf)). After first apply, set real values manually plus `xtremeidiots-task-key` per [docs/manual-steps.md](docs/manual-steps.md).
- Action groups: p0–p4 groups are created per env ([terraform/monitor_action_groups.tf](terraform/monitor_action_groups.tf)); SMS/email/app push only in prd. `locals.action_group_map` centralizes severity→group mapping ([terraform/locals.tf](terraform/locals.tf)).
- Workbooks: JSON files under [terraform/workbooks](terraform/workbooks) are auto-discovered; each deploys with a random GUID name but display name `platform-monitoring-{file-stem}-{environment}` ([terraform/workbooks.tf](terraform/workbooks.tf)). Add/update JSON to change UX.
- Log Analytics: One workspace per env at the primary location with 30-day retention ([terraform/log_analytics.tf](terraform/log_analytics.tf)). Outputs expose name/id/workspace_id for downstream use ([terraform/outputs.tf](terraform/outputs.tf)).
- Subscriptions map: Root surfaces the provided subscription list via data source and outputs for reuse ([terraform/data.subscriptions.tf](terraform/data.subscriptions.tf), [terraform/outputs.tf](terraform/outputs.tf)).
- Subscription alerts module: Uses alias `azurerm.action_group` to look up shared action groups in the monitoring subscription ([terraform-sub/data.monitor_action_groups.tf](terraform-sub/data.monitor_action_groups.tf)); creates ResourceHealth + ServiceHealth alerts per severity to those groups ([terraform-sub/resource_health_alerts.tf](terraform-sub/resource_health_alerts.tf), [terraform-sub/service_health_alerts.tf](terraform-sub/service_health_alerts.tf)).
- Tags/conventions: Keep `Environment`, `Workload`, `DeployedBy`, `Git` aligned with tfvars so workbooks and filters stay coherent.
- Extending: Reuse existing provider aliases for cross-subscription resources; follow naming/tagging patterns and primary-location assumption (most resources use `var.locations[0]`).
